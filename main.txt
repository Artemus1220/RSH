local SG = Instance.new("ScreenGui")
SG.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
SG.Name = "RSH"
SG.ResetOnSpawn = false

-- Создаем TweenService для плавных анимаций
local TweenService = game:GetService("TweenService")

-- Основной фрейм с анимацией
local F = Instance.new("Frame")
F.Size = UDim2.new(0, 1000, 0, 700)
F.Position = UDim2.new(0.5, 0, 0.5, 0)
F.AnchorPoint = Vector2.new(0.5, 0.5)
F.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
F.BackgroundTransparency = 0.1
F.BorderSizePixel = 0
F.Parent = SG

-- Анимация появления/исчезновения
local function TweenFrame(visible)
    local tweenInfo = TweenInfo.new(
        0.3,
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.Out
    )
    
    if visible then
        F.Visible = true
        local tween = TweenService:Create(F, tweenInfo, {
            Size = UDim2.new(0, 1000, 0, 700),
            BackgroundTransparency = 0.1
        })
        tween:Play()
    else
        local tween = TweenService:Create(F, tweenInfo, {
            Size = UDim2.new(0, 0, 0, 700),
            BackgroundTransparency = 1
        })
        tween:Play()
        tween.Completed:Connect(function()
            F.Visible = false
        end)
    end
end

-- Кнопка закрытия/открытия с анимацией
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Text = "☰"
ToggleButton.TextColor3 = Color3.new(1, 1, 1)
ToggleButton.TextSize = 18
ToggleButton.Size = UDim2.new(0, 40, 0, 40)
ToggleButton.Position = UDim2.new(1, -50, 0, 10)
ToggleButton.AnchorPoint = Vector2.new(1, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
ToggleButton.BorderSizePixel = 0
ToggleButton.AutoButtonColor = false
ToggleButton.Parent = SG

-- Заголовок с анимацией
local Title = Instance.new("TextLabel")
Title.Text = "Roblox Studio Hack"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Size = UDim2.new(1, -100, 0, 50)
Title.Position = UDim2.new(0, 50, 0, 0)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22
Title.Parent = F

-- Кнопка полёта с анимацией
local FlyButton = Instance.new("TextButton")
FlyButton.Text = "ВКЛЮЧИТЬ ПОЛЁТ"
FlyButton.TextColor3 = Color3.new(1, 1, 1)
FlyButton.Size = UDim2.new(0, 300, 0, 60)
FlyButton.Position = UDim2.new(0.3, -150, 0.15, -30)
FlyButton.AnchorPoint = Vector2.new(0.5, 0.5)
FlyButton.BackgroundColor3 = Color3.fromRGB(80, 80, 255)
FlyButton.BorderSizePixel = 0
FlyButton.TextSize = 18
FlyButton.Font = Enum.Font.GothamBold
FlyButton.Parent = F

-- Фрейм управления скоростью полёта
local SpeedFrame = Instance.new("Frame")
SpeedFrame.Size = UDim2.new(0, 300, 0, 80)
SpeedFrame.Position = UDim2.new(0.3, -150, 0.3, -30)
SpeedFrame.AnchorPoint = Vector2.new(0.5, 0.5)
SpeedFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SpeedFrame.BorderSizePixel = 0
SpeedFrame.Parent = F

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Text = "Скорость полёта:"
SpeedLabel.TextColor3 = Color3.new(1, 1, 1)
SpeedLabel.Size = UDim2.new(1, -20, 0, 20)
SpeedLabel.Position = UDim2.new(0, 10, 0, 5)
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 14
SpeedLabel.Parent = SpeedFrame

local SpeedBox = Instance.new("TextBox")
SpeedBox.PlaceholderText = "Текущая: 50"
SpeedBox.Text = "50"
SpeedBox.Size = UDim2.new(0.6, -10, 0, 25)
SpeedBox.Position = UDim2.new(0, 5, 0, 30)
SpeedBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
SpeedBox.TextColor3 = Color3.new(1, 1, 1)
SpeedBox.Parent = SpeedFrame

local ApplySpeedButton = Instance.new("TextButton")
ApplySpeedButton.Text = "Применить"
ApplySpeedButton.TextColor3 = Color3.new(1, 1, 1)
ApplySpeedButton.Size = UDim2.new(0.35, -10, 0, 25)
ApplySpeedButton.Position = UDim2.new(0.65, 5, 0, 30)
ApplySpeedButton.BackgroundColor3 = Color3.fromRGB(80, 80, 255)
ApplySpeedButton.BorderSizePixel = 0
ApplySpeedButton.TextSize = 14
ApplySpeedButton.Parent = SpeedFrame

-- Фрейм управления скоростью ходьбы
local WalkSpeedFrame = Instance.new("Frame")
WalkSpeedFrame.Size = UDim2.new(0, 300, 0, 80)
WalkSpeedFrame.Position = UDim2.new(0.7, -150, 0.15, -30)
WalkSpeedFrame.AnchorPoint = Vector2.new(0.5, 0.5)
WalkSpeedFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
WalkSpeedFrame.BorderSizePixel = 0
WalkSpeedFrame.Parent = F

local WalkSpeedLabel = Instance.new("TextLabel")
WalkSpeedLabel.Text = "Скорость ходьбы:"
WalkSpeedLabel.TextColor3 = Color3.new(1, 1, 1)
WalkSpeedLabel.Size = UDim2.new(1, -20, 0, 20)
WalkSpeedLabel.Position = UDim2.new(0, 10, 0, 5)
WalkSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
WalkSpeedLabel.BackgroundTransparency = 1
WalkSpeedLabel.Font = Enum.Font.Gotham
WalkSpeedLabel.TextSize = 14
WalkSpeedLabel.Parent = WalkSpeedFrame

local WalkSpeedBox = Instance.new("TextBox")
WalkSpeedBox.PlaceholderText = "Текущая: 16"
WalkSpeedBox.Text = "16"
WalkSpeedBox.Size = UDim2.new(0.6, -10, 0, 25)
WalkSpeedBox.Position = UDim2.new(0, 5, 0, 30)
WalkSpeedBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
WalkSpeedBox.TextColor3 = Color3.new(1, 1, 1)
WalkSpeedBox.Parent = WalkSpeedFrame

local ApplyWalkSpeedButton = Instance.new("TextButton")
ApplyWalkSpeedButton.Text = "Применить"
ApplyWalkSpeedButton.TextColor3 = Color3.new(1, 1, 1)
ApplyWalkSpeedButton.Size = UDim2.new(0.35, -10, 0, 25)
ApplyWalkSpeedButton.Position = UDim2.new(0.65, 5, 0, 30)
ApplyWalkSpeedButton.BackgroundColor3 = Color3.fromRGB(80, 80, 255)
ApplyWalkSpeedButton.BorderSizePixel = 0
ApplyWalkSpeedButton.TextSize = 14
ApplyWalkSpeedButton.Parent = WalkSpeedFrame

-- Кнопка подсветки игроков с анимацией
local HighlightButton = Instance.new("TextButton")
HighlightButton.Text = "ПОДСВЕТКА ИГРОКОВ"
HighlightButton.TextColor3 = Color3.new(1, 1, 1)
HighlightButton.Size = UDim2.new(0, 300, 0, 60)
HighlightButton.Position = UDim2.new(0.3, -150, 0.45, -30)
HighlightButton.AnchorPoint = Vector2.new(0.5, 0.5)
HighlightButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
HighlightButton.BorderSizePixel = 0
HighlightButton.TextSize = 18
HighlightButton.Font = Enum.Font.GothamBold
HighlightButton.Parent = F

-- Кнопка NoClip с анимацией
local NoClipButton = Instance.new("TextButton")
NoClipButton.Text = "ВКЛЮЧИТЬ NOCLIP"
NoClipButton.TextColor3 = Color3.new(1, 1, 1)
NoClipButton.Size = UDim2.new(0, 300, 0, 60)
NoClipButton.Position = UDim2.new(0.3, -150, 0.6, -30)
NoClipButton.AnchorPoint = Vector2.new(0.5, 0.5)
NoClipButton.BackgroundColor3 = Color3.fromRGB(150, 50, 150)
NoClipButton.BorderSizePixel = 0
NoClipButton.TextSize = 18
NoClipButton.Font = Enum.Font.GothamBold
NoClipButton.Parent = F

-- Поле для ввода цвета с анимацией
local ColorInputFrame = Instance.new("Frame")
ColorInputFrame.Size = UDim2.new(0, 300, 0, 100)
ColorInputFrame.Position = UDim2.new(0.3, -150, 0.75, -50)
ColorInputFrame.AnchorPoint = Vector2.new(0.5, 0.5)
ColorInputFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
ColorInputFrame.BorderSizePixel = 0
ColorInputFrame.Parent = F

local ColorLabel = Instance.new("TextLabel")
ColorLabel.Text = "RGB цвет (0-255):"
ColorLabel.TextColor3 = Color3.new(1, 1, 1)
ColorLabel.Size = UDim2.new(1, -20, 0, 20)
ColorLabel.Position = UDim2.new(0, 10, 0, 5)
ColorLabel.TextXAlignment = Enum.TextXAlignment.Left
ColorLabel.BackgroundTransparency = 1
ColorLabel.Font = Enum.Font.Gotham
ColorLabel.TextSize = 14
ColorLabel.Parent = ColorInputFrame

local RBox = Instance.new("TextBox")
RBox.PlaceholderText = "R (красный)"
RBox.Size = UDim2.new(0.3, -10, 0, 25)
RBox.Position = UDim2.new(0, 5, 0, 30)
RBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
RBox.TextColor3 = Color3.new(1, 1, 1)
RBox.Parent = ColorInputFrame

local GBox = Instance.new("TextBox")
GBox.PlaceholderText = "G (зеленый)"
GBox.Size = UDim2.new(0.3, -10, 0, 25)
GBox.Position = UDim2.new(0.35, 0, 0, 30)
GBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
GBox.TextColor3 = Color3.new(1, 1, 1)
GBox.Parent = ColorInputFrame

local BBox = Instance.new("TextBox")
BBox.PlaceholderText = "B (синий)"
BBox.Size = UDim2.new(0.3, -10, 0, 25)
BBox.Position = UDim2.new(0.7, 0, 0, 30)
BBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
BBox.TextColor3 = Color3.new(1, 1, 1)
BBox.Parent = ColorInputFrame

local ApplyColorButton = Instance.new("TextButton")
ApplyColorButton.Text = "Применить цвет"
ApplyColorButton.TextColor3 = Color3.new(1, 1, 1)
ApplyColorButton.Size = UDim2.new(1, -20, 0, 25)
ApplyColorButton.Position = UDim2.new(0, 10, 0, 65)
ApplyColorButton.BackgroundColor3 = Color3.fromRGB(80, 80, 255)
ApplyColorButton.BorderSizePixel = 0
ApplyColorButton.TextSize = 14
ApplyColorButton.Parent = ColorInputFrame

-- Переменные для управления
local isVisible = true
local isFlying = false
local isHighlighting = false
local isNoClip = false
local flySpeed = 50
local walkSpeed = 16
local bodyGyro, bodyVelocity
local highlights = {}
local highlightColor = Color3.fromRGB(255, 50, 50)
local connections = {}
local originalWalkSpeed = 16

-- Функция для плавных уведомлений
local function ShowNotification(text)
    local Notification = Instance.new("TextLabel")
    Notification.Text = text
    Notification.TextColor3 = Color3.new(1, 1, 1)
    Notification.Size = UDim2.new(0, 300, 0, 60)
    Notification.Position = UDim2.new(1, -320, 1, -80)
    Notification.AnchorPoint = Vector2.new(1, 1)
    Notification.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Notification.BackgroundTransparency = 0.3
    Notification.BorderSizePixel = 0
    Notification.TextSize = 16
    Notification.Font = Enum.Font.Gotham
    Notification.Parent = SG
    
    Notification.Size = UDim2.new(0, 0, 0, 60)
    local tweenIn = TweenService:Create(Notification, TweenInfo.new(0.3), {
        Size = UDim2.new(0, 300, 0, 60)
    })
    tweenIn:Play()
    
    delay(3, function()
        local tweenOut = TweenService:Create(Notification, TweenInfo.new(0.3), {
            Size = UDim2.new(0, 0, 0, 60)
        })
        tweenOut:Play()
        tweenOut.Completed:Connect(function()
            Notification:Destroy()
        end)
    end)
end

-- Функция для плавного изменения цвета кнопки
local function TweenButtonColor(button, color)
    local tween = TweenService:Create(button, TweenInfo.new(0.2), {
        BackgroundColor3 = color
    })
    tween:Play()
end

-- Функция переключения видимости с анимацией
ToggleButton.MouseButton1Click:Connect(function()
    isVisible = not isVisible
    TweenFrame(isVisible)
    ShowNotification(isVisible and "Меню открыто" or "Меню закрыто")
    
    -- Анимация кнопки
    TweenButtonColor(ToggleButton, isVisible and Color3.fromRGB(255, 60, 60) or Color3.fromRGB(60, 255, 60))
    ToggleButton.Text = isVisible and "X" or "☰"
end)

-- Функция полёта с анимацией
local function ToggleFlight()
    local character = game.Players.LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart then return end
    
    if not isFlying then
        -- Анимация кнопки
        TweenButtonColor(FlyButton, Color3.fromRGB(255, 80, 80))
        
        humanoid.PlatformStand = true
        
        -- Плавное создание физических объектов
        task.spawn(function()
            bodyGyro = Instance.new("BodyGyro")
            bodyGyro.P = 10000
            bodyGyro.MaxTorque = Vector3.new(10000, 10000, 10000)
            bodyGyro.CFrame = workspace.CurrentCamera.CFrame
            bodyGyro.Parent = rootPart
            
            bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            bodyVelocity.MaxForce = Vector3.new(10000, 10000, 10000)
            bodyVelocity.Parent = rootPart
            
            FlyButton.Text = "ВЫКЛЮЧИТЬ ПОЛЁТ"
            ShowNotification("Полёт включен (Скорость: "..flySpeed..")")
            isFlying = true
        end)
    else
        -- Анимация кнопки
        TweenButtonColor(FlyButton, Color3.fromRGB(80, 80, 255))
        
        humanoid.PlatformStand = false
        if bodyGyro then bodyGyro:Destroy() end
        if bodyVelocity then bodyVelocity:Destroy() end
        
        FlyButton.Text = "ВКЛЮЧИТЬ ПОЛЁТ"
        ShowNotification("Полёт выключен")
        isFlying = false
    end
end

-- Функция для изменения скорости полёта
local function ApplySpeed()
    local newSpeed = tonumber(SpeedBox.Text) or 50
    newSpeed = math.clamp(newSpeed, 1, 1000)
    
    flySpeed = newSpeed
    SpeedBox.Text = tostring(flySpeed)
    
    -- Плавное изменение текста
    local tween = TweenService:Create(SpeedBox, TweenInfo.new(0.2), {
        TextColor3 = Color3.new(0, 1, 0)
    })
    tween:Play()
    tween.Completed:Wait()
    task.wait(0.5)
    tween = TweenService:Create(SpeedBox, TweenInfo.new(0.2), {
        TextColor3 = Color3.new(1, 1, 1)
    })
    tween:Play()
    
    ShowNotification("Скорость полёта: "..flySpeed)
end

-- Функция для изменения скорости ходьбы
local function ApplyWalkSpeed()
    local newSpeed = tonumber(WalkSpeedBox.Text) or 16
    newSpeed = math.clamp(newSpeed, 1, 100)
    
    walkSpeed = newSpeed
    WalkSpeedBox.Text = tostring(walkSpeed)
    
    -- Применяем скорость
    local character = game.Players.LocalPlayer.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = walkSpeed
        end
    end
    
    -- Плавное изменение текста
    local tween = TweenService:Create(WalkSpeedBox, TweenInfo.new(0.2), {
        TextColor3 = Color3.new(0, 1, 0)
    })
    tween:Play()
    tween.Completed:Wait()
    task.wait(0.5)
    tween = TweenService:Create(WalkSpeedBox, TweenInfo.new(0.2), {
        TextColor3 = Color3.new(1, 1, 1)
    })
    tween:Play()
    
    ShowNotification("Скорость ходьбы: "..walkSpeed)
end

-- Улучшенная функция подсветки игроков
local function ToggleHighlight()
    isHighlighting = not isHighlighting
    
    if isHighlighting then
        -- Анимация кнопки
        TweenButtonColor(HighlightButton, Color3.fromRGB(80, 255, 80))
        HighlightButton.Text = "ОТКЛЮЧИТЬ ПОДСВЕТКУ"
        ShowNotification("Подсветка игроков включена")
        
        -- Очищаем старые подсветки
        CleanupHighlights()
        
        -- Подсвечиваем всех игроков
        for _, player in ipairs(game.Players:GetPlayers()) do
            if player ~= game.Players.LocalPlayer then
                -- Создаем подсветку с задержкой для плавности
                task.spawn(function()
                    if player.Character then
                        AddHighlight(player)
                    end
                    
                    -- Обработчик для нового персонажа
                    local conn = player.CharacterAdded:Connect(function(char)
                        if isHighlighting then
                            AddHighlight(player)
                        end
                    end)
                    table.insert(connections, conn)
                end)
            end
        end
    else
        -- Анимация кнопки
        TweenButtonColor(HighlightButton, Color3.fromRGB(255, 80, 80))
        HighlightButton.Text = "ПОДСВЕТКА ИГРОКОВ"
        ShowNotification("Подсветка игроков выключена")
        
        CleanupHighlights()
    end
end

-- Функция очистки подсветок
local function CleanupHighlights()
    for player, highlight in pairs(highlights) do
        if highlight then
            highlight:Destroy()
        end
    end
    highlights = {}
end

-- Функция добавления подсветки для игрока
local function AddHighlight(player)
    if not player or not player.Character then return end
    
    -- Удаляем старую подсветку если есть
    if highlights[player] then
        highlights[player]:Destroy()
    end
    
    -- Создаем новую подсветку
    local highlight = Instance.new("Highlight")
    highlight.FillColor = highlightColor
    highlight.OutlineColor = Color3.new(
        math.min(highlightColor.R * 1.5, 1),
        math.min(highlightColor.G * 1.5, 1),
        math.min(highlightColor.B * 1.5, 1)
    )
    highlight.Parent = player.Character
    highlights[player] = highlight
    
    -- Обработчик для частей персонажа
    local conn = player.Character.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("BasePart") and highlights[player] then
            highlights[player].Parent = player.Character
        end
    end)
    table.insert(connections, conn)
end

-- Функция NoClip с анимацией
local function ToggleNoClip()
    isNoClip = not isNoClip
    local character = game.Players.LocalPlayer.Character
    if not character then return end
    
    if isNoClip then
        -- Анимация кнопки
        TweenButtonColor(NoClipButton, Color3.fromRGB(200, 100, 200))
        NoClipButton.Text = "ВЫКЛЮЧИТЬ NOCLIP"
        ShowNotification("NoClip включен")
        
        -- Сохраняем оригинальную скорость
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            originalWalkSpeed = humanoid.WalkSpeed
        end
        
        -- Делаем все части Non-Collidable
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
        -- Обработчик для новых частей
        local conn = character.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("BasePart") then
                descendant.CanCollide = false
            end
        end)
        table.insert(connections, conn)
    else
        -- Анимация кнопки
        TweenButtonColor(NoClipButton, Color3.fromRGB(150, 50, 150))
        NoClipButton.Text = "ВКЛЮЧИТЬ NOCLIP"
        ShowNotification("NoClip выключен")
        
        -- Восстанавливаем Collision
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
        
        -- Восстанавливаем скорость
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = originalWalkSpeed
        end
    end
end

-- Функция для применения цвета подсветки
local function ApplyHighlightColor()
    local r = tonumber(RBox.Text) or 255
    local g = tonumber(GBox.Text) or 50
    local b = tonumber(BBox.Text) or 50
    
    r = math.clamp(r, 0, 255)
    g = math.clamp(g, 0, 255)
    b = math.clamp(b, 0, 255)
    
    highlightColor = Color3.fromRGB(r, g, b)
    
    -- Анимация изменения цвета
    local tween = TweenService:Create(ApplyColorButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    })
    tween:Play()
    tween.Completed:Wait()
    task.wait(0.3)
    tween = TweenService:Create(ApplyColorButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(80, 80, 255)
    })
    tween:Play()
    
    if isHighlighting then
        for player, highlight in pairs(highlights) do
            if highlight and player.Character then
                highlight.FillColor = highlightColor
                highlight.OutlineColor = Color3.new(
                    math.min(highlightColor.R * 1.5, 1),
                    math.min(highlightColor.G * 1.5, 1),
                    math.min(highlightColor.B * 1.5, 1)
                )
                highlight.Parent = player.Character
            end
        end
    end
    
    ShowNotification(string.format("Цвет изменён: %d, %d, %d", r, g, b))
end

-- Очистка всех соединений
local function CleanupConnections()
    for _, conn in ipairs(connections) do
        conn:Disconnect()
    end
    connections = {}
end

-- Обработчики кнопок
FlyButton.MouseButton1Click:Connect(ToggleFlight)
HighlightButton.MouseButton1Click:Connect(ToggleHighlight)
NoClipButton.MouseButton1Click:Connect(ToggleNoClip)
ApplyColorButton.MouseButton1Click:Connect(ApplyHighlightColor)
ApplySpeedButton.MouseButton1Click:Connect(ApplySpeed)
ApplyWalkSpeedButton.MouseButton1Click:Connect(ApplyWalkSpeed)

-- Обработчик для новых игроков
game.Players.PlayerAdded:Connect(function(player)
    if isHighlighting then
        local conn = player.CharacterAdded:Connect(function(char)
            AddHighlight(player)
        end)
        table.insert(connections, conn)
    end
end)

-- Управление полётом
local UserInputService = game:GetService("UserInputService")
local movingDirection = Vector3.new(0, 0, 0)

local function UpdateFlight(dt)
    if not isFlying then return end
    
    local character = game.Players.LocalPlayer.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart or not bodyGyro or not bodyVelocity then return end
    
    if movingDirection.Magnitude > 0 then
        local moveDirection = workspace.CurrentCamera.CFrame:VectorToWorldSpace(movingDirection)
        bodyVelocity.Velocity = moveDirection * flySpeed
        bodyGyro.CFrame = workspace.CurrentCamera.CFrame
    else
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    end
end

-- Обработка ввода для полёта
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not isFlying or gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.W then
        movingDirection = movingDirection + Vector3.new(0, 0, -1)
    elseif input.KeyCode == Enum.KeyCode.S then
        movingDirection = movingDirection + Vector3.new(0, 0, 1)
    elseif input.KeyCode == Enum.KeyCode.D then
        movingDirection = movingDirection + Vector3.new(1, 0, 0)
    elseif input.KeyCode == Enum.KeyCode.A then
        movingDirection = movingDirection + Vector3.new(-1, 0, 0)
    elseif input.KeyCode == Enum.KeyCode.Space then
        movingDirection = movingDirection + Vector3.new(0, 1, 0)
    elseif input.KeyCode == Enum.KeyCode.LeftShift then
        movingDirection = movingDirection + Vector3.new(0, -1, 0)
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if not isFlying or gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.W then
        movingDirection = movingDirection - Vector3.new(0, 0, -1)
    elseif input.KeyCode == Enum.KeyCode.S then
        movingDirection = movingDirection - Vector3.new(0, 0, 1)
    elseif input.KeyCode == Enum.KeyCode.D then
        movingDirection = movingDirection - Vector3.new(1, 0, 0)
    elseif input.KeyCode == Enum.KeyCode.A then
        movingDirection = movingDirection - Vector3.new(-1, 0, 0)
    elseif input.KeyCode == Enum.KeyCode.Space then
        movingDirection = movingDirection - Vector3.new(0, 1, 0)
    elseif input.KeyCode == Enum.KeyCode.LeftShift then
        movingDirection = movingDirection - Vector3.new(0, -1, 0)
    end
end)

-- Основной цикл
game:GetService("RunService").Heartbeat:Connect(function(dt)
    UpdateFlight(dt)
    
    -- Автоматическая очистка несуществующих подсветок
    if isHighlighting then
        for player, highlight in pairs(highlights) do
            if not player or not player.Character or not highlight then
                if highlight then highlight:Destroy() end
                highlights[player] = nil
            end
        end
    end
    
    -- Автоматическое применение скорости ходьбы при появлении персонажа
    local character = game.Players.LocalPlayer.Character
    if character and not isNoClip then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid and humanoid.WalkSpeed ~= walkSpeed then
            humanoid.WalkSpeed = walkSpeed
        end
    end
end)

-- Очистка при выходе
game.Players.LocalPlayer.CharacterRemoving:Connect(function()
    CleanupConnections()
    CleanupHighlights()
end)

-- Применяем начальную скорость ходьбы
local function Initialize()
    local character = game.Players.LocalPlayer.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            walkSpeed = humanoid.WalkSpeed
            WalkSpeedBox.Text = tostring(walkSpeed)
            originalWalkSpeed = walkSpeed
        end
    end
end

-- Задержка для инициализации
task.wait(1)
Initialize()
